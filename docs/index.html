<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="bg-white shadow-xl rounded-2xl p-8 max-w-sm w-full text-center space-y-6">
        <h1 class="text-4xl font-bold text-indigo-600">Step Tracker</h1>
        <p class="text-gray-500">Track your progress and stay active.</p>

        <div id="status" class="text-sm text-gray-400">
            Initializing...
        </div>

        <div id="step-display" class="hidden">
            <div class="bg-indigo-100 rounded-xl p-6 mb-4">
                <p class="text-sm font-medium text-indigo-600 uppercase tracking-wide">Steps Today</p>
                <p id="step-count" class="text-6xl font-extrabold text-indigo-700 mt-2">0</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8cKvTGY-dGfC_Hj7quM_BN8GYfpnBE6g",
            authDomain: "step-counter-dfa03.firebaseapp.com",
            projectId: "step-counter-dfa03",
            storageBucket: "step-counter-dfa03.firebasestorage.app",
            messagingSenderId: "28666344542",
            appId: "1:28666344542:web:eebb589b662868ac0eb0cf"
        };

        const appId = 'step-counter-app';

        let app;
        let db;
        let auth;
        let userId;

        const statusEl = document.getElementById('status');
        const stepDisplayEl = document.getElementById('step-display');
        const stepCountEl = document.getElementById('step-count');
        const addStepBtn = document.getElementById('add-step-btn'); // This element is no longer used but kept for simplicity

        // Variables for motion detection
        let lastZ = 0;
        let threshold = 5; // Adjust this value based on sensitivity
        let stepCount = 0;
        let lastStepTime = 0;
        const cooldown = 300; // milliseconds to prevent double-counting

        // Function to handle database connection
        async function connectToDb() {
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    statusEl.textContent = 'Error: Firebase config not found. Please add your config to the code.';
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        statusEl.textContent = 'Ready! Start moving.';
                        stepDisplayEl.classList.remove('hidden');
                        
                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/steps/today`);
                        onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                const steps = data.count || 0;
                                stepCount = steps; // Sync local counter with Firestore
                                stepCountEl.textContent = steps;
                            } else {
                                stepCountEl.textContent = 0;
                            }
                        });

                        // Start listening for device motion
                        if (window.DeviceMotionEvent) {
                            window.addEventListener('devicemotion', handleMotion);
                        } else {
                            statusEl.textContent = 'Device motion sensor not available. Step tracking disabled.';
                        }
                    }
                });

            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                statusEl.textContent = 'Error: Failed to connect to Firebase. Check the console for details.';
            }
        }

        // Handle device motion event
        async function handleMotion(event) {
            const acceleration = event.accelerationIncludingGravity;
            if (!acceleration) return;

            const currentZ = acceleration.z;
            const diff = Math.abs(currentZ - lastZ);

            if (diff > threshold && (Date.now() - lastStepTime) > cooldown) {
                lastStepTime = Date.now();
                await updateStepCount(stepCount + 1);
            }
            lastZ = currentZ;
        }

        // Update step count in Firestore
        async function updateStepCount(newCount) {
            if (!userId) {
                statusEl.textContent = 'Please wait, app is not ready yet.';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/steps/today`);

            try {
                await setDoc(userDocRef, { count: newCount, lastUpdated: new Date() }, { merge: true });
            } catch (e) {
                console.error("Error updating step count:", e);
                statusEl.textContent = 'Error updating step count. See console.';
            }
        }

        window.onload = connectToDb;
    </script>
</body>
</html>
